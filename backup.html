<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup & Restore Data - PACIFI PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1B1F3B;
            --secondary-color: #8B0000;
            --accent-color: #4285f4;
            --light-color: #f8f9fa;
            --border-color: #e0e0e0;
            --text-color: #333;
            --success-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc05;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            min-height: 100vh;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .brand {
            font-size: 24px;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-name {
            margin-right: 15px;
            font-size: 14px;
        }
        
        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c5221f;
        }
        
        .sidebar {
            width: 250px;
            background-color: white;
            height: calc(100vh - 70px);
            position: fixed;
            left: 0;
            top: 70px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
            z-index: 90;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-color);
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: calc(100vh - 70px);
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .backup-container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .backup-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .backup-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0d0e1f;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2d8e47;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c5221f;
        }
        
        .file-input {
            display: none;
        }
        
        .backup-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .backup-info h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .backup-info ul {
            margin-left: 20px;
        }
        
        .backup-info li {
            margin-bottom: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .last-backup {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <div class="brand">PACIFI PRO</div>
        </div>
        <div class="user-info">
            <div class="user-name" id="userWelcome">Loading...</div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
    
    <div class="sidebar">
        <ul class="sidebar-menu">
            <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="pelanggan.html"><i class="fas fa-users"></i> Data Pelanggan</a></li>
            <li><a href="jenis-invoice.html"><i class="fas fa-file-alt"></i> Jenis Invoice</a></li>
            <li><a href="invoice.html"><i class="fas fa-receipt"></i> Invoice</a></li>
            <li><a href="laporan-penjualan.html"><i class="fas fa-chart-line"></i> Laporan Penjualan</a></li>
            <li><a href="program_keuangan_akun.html"><i class="fas fa-coins"></i> Input Akun</a></li>
            <li><a href="program_keuangan_jurnal.html"><i class="fas fa-book"></i> Jurnal</a></li>
            <li><a href="program_keuangan_laporan.html"><i class="fas fa-chart-pie"></i> Laporan Keuangan</a></li>
            <li><a href="neraca.html"><i class="fas fa-balance-scale"></i> Neraca</a></li>
            <li><a href="laba_rugi.html"><i class="fas fa-chart-line"></i> Laba Rugi</a></li>
            <li><a href="arus_kas.html"><i class="fas fa-money-bill-wave"></i> Arus Kas</a></li>
            <li><a href="backup.html" class="active"><i class="fas fa-database"></i> Backup & Restore</a></li>
            <li><a href="pengguna.html" id="linkPengguna" style="display: none;"><i class="fas fa-user-cog"></i> Manajemen Pengguna</a></li>
        </ul>
    </div>
    
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">Backup & Restore Data</h1>
            <p class="page-subtitle">Kelola backup data sistem untuk keamanan</p>
        </div>
        
        <div class="backup-container">
            <div class="backup-section">
                <h3><i class="fas fa-download"></i> Backup Data</h3>
                <p>Buat backup dari semua data sistem</p>
                
                <button class="btn btn-primary" onclick="createFullBackup()">
                    <i class="fas fa-database"></i> Backup Semua Data
                </button>
                
                <button class="btn btn-success" onclick="createSelectiveBackup()">
                    <i class="fas fa-filter"></i> Backup Selektif
                </button>
                
                <div class="last-backup" id="lastBackupInfo">
                    Backup terakhir: Belum pernah
                </div>
                
                <div class="progress-bar" id="backupProgress">
                    <div class="progress-fill" id="backupProgressFill"></div>
                </div>
                
                <div class="backup-info">
                    <h4>Data yang akan di-backup:</h4>
                    <ul>
                        <li>Data Pelanggan</li>
                        <li>Data Invoice & Penjualan</li>
                        <li>Data Jurnal & Transaksi</li>
                        <li>Data Pengguna</li>
                        <li>Data Laporan Keuangan</li>
                        <li>Data Neraca, Laba Rugi & Arus Kas</li>
                    </ul>
                </div>
            </div>
            
            <div class="backup-section">
                <h3><i class="fas fa-upload"></i> Restore Data</h3>
                <p>Kembalikan data dari file backup</p>
                
                <input type="file" id="restoreFile" class="file-input" accept=".json" onchange="handleFileSelect(event)">
                
                <button class="btn btn-primary" onclick="document.getElementById('restoreFile').click()">
                    <i class="fas fa-file-import"></i> Pilih File Backup
                </button>
                
                <button class="btn btn-success" id="restoreBtn" onclick="restoreData()" style="display: none;">
                    <i class="fas fa-undo"></i> Restore Data
                </button>
                
                <div class="progress-bar" id="restoreProgress">
                    <div class="progress-fill" id="restoreProgressFill"></div>
                </div>
                
                <div class="backup-info">
                    <h4>Perhatian:</h4>
                    <ul>
                        <li>Restore data akan menimpa data yang ada saat ini</li>
                        <li> pastikan file backup valid dan tidak rusak</li>
                        <li>Disarankan untuk membuat backup sebelum melakukan restore</li>
                    </ul>
                </div>
            </div>
            
            <div class="backup-section">
                <h3><i class="fas fa-clock"></i> Backup Otomatis</h3>
                <p>Atur jadwal backup otomatis</p>
                
                <button class="btn btn-primary" onclick="enableAutoBackup()">
                    <i class="fas fa-play"></i> Aktifkan Backup Harian
                </button>
                
                <button class="btn btn-danger" onclick="disableAutoBackup()">
                    <i class="fas fa-stop"></i> Nonaktifkan Backup Otomatis
                </button>
                
                <div class="last-backup" id="autoBackupStatus">
                    Status: Backup otomatis tidak aktif
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // Audit Trail Integration
function logActivity(action, module, detail) {
    if (window.auditTrail) {
        window.auditTrail.log({
            action: action,
            module: module,
            detail: detail
        });
    }
}

// Override existing functions to add audit logging
if (!window.originalShowNotification) {
    window.originalShowNotification = window.showNotification;
}

window.showNotification = function(message, type = 'success') {
    if (window.originalShowNotification) {
        window.originalShowNotification(message, type);
    }
    
    // Log notification as audit activity
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user) {
        logActivity(type === 'error' ? 'error' : 'info', 'System', `Notification: ${message}`);
    }
};

// Add audit logging to login function
if (!window.originalLoginUser) {
    window.originalLoginUser = window.loginUser;
}

window.loginUser = function(username, password) {
    const result = window.originalLoginUser ? window.originalLoginUser(username, password) : null;
    
    if (result) {
        logActivity('login', 'Authentication', 'Login berhasil');
    } else {
        logActivity('login', 'Authentication', 'Login gagal');
    }
    
    return result;
};

// Add audit logging to logout function
if (!window.originalLogout) {
    window.originalLogout = window.logout;
}

window.logout = function() {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user) {
        logActivity('logout', 'Authentication', 'User logout');
    }
    
    if (window.originalLogout) {
        window.originalLogout();
    } else {
        localStorage.removeItem("currentUser");
        window.location.href = "index.html";
    }
};
        // Cek login
        window.onload = function() {
            const currentUser = localStorage.getItem("currentUser");
            if (!currentUser) {
                window.location.href = "index.html";
                return;
            }
            
            const user = JSON.parse(currentUser);
            document.getElementById("userWelcome").textContent = user.fullName + " (" + user.role + ")";
            
            if (user.role === "admin") {
                document.getElementById("linkPengguna").style.display = "block";
            }
            
            // Load last backup info
            loadLastBackupInfo();
            checkAutoBackupStatus();
        };
        
        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type = 'success') {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add("show");
            
            setTimeout(() => {
                notification.classList.remove("show");
            }, 3000);
        }
        
        // Fungsi logout
        function logout() {
            localStorage.removeItem("currentUser");
            window.location.href = "index.html";
        }
        
        // Fungsi untuk membuat backup lengkap
        function createFullBackup() {
            try {
                showNotification("Memulai backup data...");
                
                // Tampilkan progress bar
                const progressBar = document.getElementById("backupProgress");
                const progressFill = document.getElementById("backupProgressFill");
                progressBar.style.display = "block";
                
                // Simulasi progress
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    progressFill.style.width = progress + "%";
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        
                        // Kumpulkan semua data
                        const backupData = {
                            timestamp: new Date().toISOString(),
                            version: "1.0",
                            data: {
                                dataPelanggan: localStorage.getItem("dataPelanggan"),
                                dataPenjualan: localStorage.getItem("dataPenjualan"),
                                dataJenisInvoice: localStorage.getItem("dataJenisInvoice"),
                                dataJurnal: localStorage.getItem("dataJurnal"),
                                dataLaporan: localStorage.getItem("dataLaporan"),
                                laporanKeuangan: localStorage.getItem("laporanKeuangan"),
                                users: localStorage.getItem("users"),
                                neraca: localStorage.getItem("neraca"),
                                labaBersih: localStorage.getItem("labaBersih"),
                                arusKas: localStorage.getItem("arusKas"),
                                dashboardData: localStorage.getItem("dashboardData")
                            }
                        };
                        
                        // Convert ke blob dan download
                        const dataStr = JSON.stringify(backupData, null, 2);
                        const dataBlob = new Blob([dataStr], {type: 'application/json'});
                        
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(dataBlob);
                        link.download = `backup_pacifi_pro_${new Date().toISOString().split('T')[0]}.json`;
                        link.click();
                        
                        // Simpan info backup terakhir
                        localStorage.setItem('lastBackup', new Date().toISOString());
                        loadLastBackupInfo();
                        
                        showNotification("Backup berhasil dibuat!");
                        
                        // Sembunyikan progress bar
                        setTimeout(() => {
                            progressBar.style.display = "none";
                            progressFill.style.width = "0%";
                        }, 1000);
                    }
                }, 200);
            } catch (error) {
                console.error("Error creating backup:", error);
                showNotification("Gagal membuat backup: " + error.message, "error");
            }
        }
        
        // Fungsi untuk membuat backup selektif
        function createSelectiveBackup() {
            try {
                const selectedData = {};
                
                // Tampilkan dialog untuk memilih data
                const dataTypes = [
                    { key: 'dataPelanggan', label: 'Data Pelanggan' },
                    { key: 'dataPenjualan', label: 'Data Penjualan' },
                    { key: 'dataJurnal', label: 'Data Jurnal' },
                    { key: 'users', label: 'Data Pengguna' },
                    { key: 'laporanKeuangan', label: 'Laporan Keuangan' }
                ];
                
                let html = '<div style="padding: 20px;"><h3>Pilih Data untuk Backup:</h3>';
                dataTypes.forEach(type => {
                    html += `
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" value="${type.key}" checked> ${type.label}
                        </label>
                    `;
                });
                html += '<button onclick="processSelectiveBackup()">Backup</button></div>';
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center;
                    justify-content: center; z-index: 1000;
                `;
                modal.innerHTML = html;
                document.body.appendChild(modal);
                
                // Simpan fungsi untuk dipanggil nanti
                window.processSelectiveBackup = function() {
                    const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
                    checkboxes.forEach(cb => {
                        selectedData[cb.value] = localStorage.getItem(cb.value);
                    });
                    
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        version: "1.0",
                        data: selectedData
                    };
                    
                    const dataStr = JSON.stringify(backupData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `backup_selektif_pacifi_pro_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    document.body.removeChild(modal);
                    showNotification("Backup selektif berhasil dibuat!");
                };
                
            } catch (error) {
                console.error("Error creating selective backup:", error);
                showNotification("Gagal membuat backup selektif: " + error.message, "error");
            }
        }
        
        // Fungsi untuk menangani file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('restoreBtn').style.display = 'inline-flex';
                showNotification(`File terpilih: ${file.name}`);
            }
        }
        
        // Fungsi untuk restore data
        function restoreData() {
            try {
                const fileInput = document.getElementById('restoreFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showNotification("Pilih file backup terlebih dahulu!", "error");
                    return;
                }
                
                if (!confirm("Apakah Anda yakin ingin restore data? Data saat ini akan ditimpa!")) {
                    return;
                }
                
                showNotification("Memulai restore data...");
                
                // Tampilkan progress bar
                const progressBar = document.getElementById("restoreProgress");
                const progressFill = document.getElementById("restoreProgressFill");
                progressBar.style.display = "block";
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validasi file backup
                        if (!backupData.version || !backupData.data) {
                            throw new Error("File backup tidak valid!");
                        }
                        
                        // Simulasi progress
                        let progress = 0;
                        const interval = setInterval(() => {
                            progress += 10;
                            progressFill.style.width = progress + "%";
                            
                            if (progress >= 100) {
                                clearInterval(interval);
                                
                                // Restore data
                                Object.keys(backupData.data).forEach(key => {
                                    if (backupData.data[key]) {
                                        localStorage.setItem(key, backupData.data[key]);
                                    }
                                });
                                
                                // Reset form
                                fileInput.value = '';
                                document.getElementById('restoreBtn').style.display = 'none';
                                
                                showNotification("Data berhasil di-restore!");
                                
                                // Sembunyikan progress bar
                                setTimeout(() => {
                                    progressBar.style.display = "none";
                                    progressFill.style.width = "0%";
                                }, 1000);
                            }
                        }, 200);
                        
                    } catch (error) {
                        showNotification("Gagal restore data: " + error.message, "error");
                        progressBar.style.display = "none";
                    }
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                console.error("Error restoring data:", error);
                showNotification("Gagal restore data: " + error.message, "error");
            }
        }
        
        // Fungsi untuk mengaktifkan backup otomatis
        function enableAutoBackup() {
            localStorage.setItem('autoBackup', 'true');
            localStorage.setItem('autoBackupTime', new Date().toISOString());
            
            // Set interval untuk backup harian
            if (!window.backupInterval) {
                window.backupInterval = setInterval(() => {
                    createAutoBackup();
                }, 24 * 60 * 60 * 1000); // 24 jam
            }
            
            checkAutoBackupStatus();
            showNotification("Backup otomatis diaktifkan");
        }
        
        // Fungsi untuk menonaktifkan backup otomatis
        function disableAutoBackup() {
            localStorage.setItem('autoBackup', 'false');
            
            if (window.backupInterval) {
                clearInterval(window.backupInterval);
                window.backupInterval = null;
            }
            
            checkAutoBackupStatus();
            showNotification("Backup otomatis dinonaktifkan");
        }
        
        // Fungsi untuk membuat backup otomatis
        function createAutoBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: "1.0",
                    auto: true,
                    data: {
                        dataPelanggan: localStorage.getItem("dataPelanggan"),
                        dataPenjualan: localStorage.getItem("dataPenjualan"),
                        dataJenisInvoice: localStorage.getItem("dataJenisInvoice"),
                        dataJurnal: localStorage.getItem("dataJurnal"),
                        dataLaporan: localStorage.getItem("dataLaporan"),
                        laporanKeuangan: localStorage.getItem("laporanKeuangan"),
                        users: localStorage.getItem("users"),
                        neraca: localStorage.getItem("neraca"),
                        labaBersih: localStorage.getItem("labaBersih"),
                        arusKas: localStorage.getItem("arusKas"),
                        dashboardData: localStorage.getItem("dashboardData")
                    }
                };
                
                // Simpan backup ke localStorage (bisa juga diupload ke server)
                localStorage.setItem('autoBackupData', JSON.stringify(backupData));
                localStorage.setItem('lastAutoBackup', new Date().toISOString());
                
                console.log("Auto backup created at:", new Date());
                
            } catch (error) {
                console.error("Error creating auto backup:", error);
            }
        }
        
        // Fungsi untuk mengecek status backup otomatis
        function checkAutoBackupStatus() {
            const autoBackup = localStorage.getItem('autoBackup') === 'true';
            const statusElement = document.getElementById('autoBackupStatus');
            
            if (autoBackup) {
                statusElement.textContent = "Status: Backup otomatis aktif";
                statusElement.style.color = "var(--success-color)";
                
                // Cek apakah perlu menjalankan interval
                if (!window.backupInterval) {
                    window.backupInterval = setInterval(() => {
                        createAutoBackup();
                    }, 24 * 60 * 60 * 1000);
                }
            } else {
                statusElement.textContent = "Status: Backup otomatis tidak aktif";
                statusElement.style.color = "var(--danger-color)";
                
                if (window.backupInterval) {
                    clearInterval(window.backupInterval);
                    window.backupInterval = null;
                }
            }
        }
        
        // Fungsi untuk memuat info backup terakhir
        function loadLastBackupInfo() {
            const lastBackup = localStorage.getItem('lastBackup');
            const infoElement = document.getElementById('lastBackupInfo');
            
            if (lastBackup) {
                const date = new Date(lastBackup);
                infoElement.textContent = `Backup terakhir: ${date.toLocaleString('id-ID')}`;
            } else {
                infoElement.textContent = "Backup terakhir: Belum pernah";
            }
        }
    </script>
</body>
</html>